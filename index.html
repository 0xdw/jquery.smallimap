<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SI Metricstest</title>
    <link rel="stylesheet" href="css/jquery.smallipop-0.1.6.min.css" type="text/css" media="all" />
    <link rel="stylesheet" href="css/main.css" type="text/css" media="all" />
  </head>
  <body>
    <div class="main">
      <h1>Smallimap Demo</h1>
      <button onclick="runSmallimapTest();">Start test</button>
      <div id="smallimap"></div>
    </div>

    <script src="js/jquery-1.7.1.min.js"></script>
    <script src="js/modernizr-2.6.0.min.js"></script>
    <script src="js/jquery.smallipop-0.1.6.min.js" type="text/javascript"></script>
    <script src="js/suntimes.js"></script>
    <script src="js/renderframe.js"></script>
    <script src="js/color-0.4.1.js" type="text/javascript"></script>
    <script src="js/world.js" type="text/javascript"></script>
    <script src="js/smallimap.js" type="text/javascript"></script>
    <script src="js/some.js" type="text/javascript"></script>

    <script type="text/javascript">

      $(function() {
        var smallimap,
            metricsClient,
            debugMode = true,
            serverUrl = 'http://www.small-improvements.com';//'http://localhost:8080'

        function log(message) {
          if (window.console && $.some.debug)
            window.console.log(message);
        }

        // Callback for activity listeners
        function drawEventOnMap(listener, scheduledTimeout, event) {
          log("Scheduling activity on the map for listener " + listener.name + " in " + scheduledTimeout + " ms");

          var eventColor,
              eventDuration = 500,
              eventWeight = 1;

          switch (event.category) {
            case 'appraisal':
              eventColor = '#658413'; // Yellow/Green
              break;
            case 'feedback':
              eventColor = '#849022'; // Light green
              break;
            case 'objective':
              eventColor = '#31577e'; // Blue
              break;
            case 'admin':
              eventColor = '#ff9c00'; // Orange
              break;
            default:
              eventColor = '#ff00ff'; // Pink
          }

          window.setTimeout(function() {
            log("Enqueing event on the map: " + event.label);

            var newEvent = new $.si.smallimap.events.BlipEvent(smallimap, {
              latitude: event.latitude,
              longitude: event.longitude,
              color: eventColor,
              weight: eventWeight,
              length: eventDuration
            });
            smallimap.enqueueEvent(newEvent);

            metricsClient.play(listener.sound);
          }, scheduledTimeout);
        }

        // Query clients from the server and show them on the map
        function getClientsForMap() {
          $.getJSON(serverUrl + '/queryClientsJSON?callback=?', function(data) {
            log("Queried clients from SI");
            var idx = 0, client;
            for (; idx < data.length; idx++) {
              client = data[idx];
              log("Adding icon for " + client);
              smallimap.addMapIcon(client.name, client.quote, 'img/marker.png', 'img/si.png', client.longitude, client.latitude);
            }
          });
        }

        // Test function for the map which creates random events all over the world
        var testIntervalId = -1;
        window.runSmallimapTest = function() {
          var lastX = 0, lastY = 0,
            pxToX = function (px) { return Math.floor(px/smallimap.dotDiameter); },
            pyToY = function (py) { return Math.floor(py/smallimap.dotDiameter); };

          /*$('#smallimap').mousemove(function (event) {
            var px = event.pageX - $(this).offset().left,// - smallimap.width,
              py = event.pageY - $(this).offset().top,
              x = pxToX(px),
              y = pyToY(py);

            if(x != lastX || y != lastY) {
              var inEvent = new $.si.smallimap.events.LensEvent(smallimap, {
                  longitude: smallimap.xToLong(x),
                  latitude: smallimap.yToLat(y),
                  eventRadius: 0,
                  duration: 128,
                  fade: "in"
              });
              smallimap.enqueueEvent(inEvent);
              var outEvent = new $.si.smallimap.events.LensEvent(smallimap, {
                  longitude: smallimap.xToLong(lastX),
                  latitude: smallimap.yToLat(lastY),
                  eventRadius: 0,
                  delay: 128,
                  duration: 256,
                  fade: "out"
              });
              smallimap.enqueueEvent(outEvent);
              lastX = x
              lastY = y
            }
          });*/

          testIntervalId = setInterval(function() {
            var event = new $.si.smallimap.events.BlipEvent(smallimap, {
              latitude: Math.random() * 180 - 90,
              longitude: Math.random() * 360 - 180,
              color: '#ff00ff',
                eventRadius: 3,
                duration: 1024,
                weight: 0.8
            });
            smallimap.enqueueEvent(event);
          }, 8);
        };
        window.stopSmallimapTest = function() {
          clearInterval(testIntervalId);
        };

        // Configure metrics client
        $.some.debug = debugMode;
        metricsClient = new $.some.SonicMetricsClient('SIMetricsClient', {
          serverUrl: serverUrl,
          sourceId: 'SIMetricsClient',
          getEventsPath: 'queryActivitiesJSON',
          getServerTime: 'queryServertimeJSON',
          soundEnabled: true,
          useLocalStorage: false,
          useLastKeyOnRequests: false
        });

        // Init map
        smallimap = $('#smallimap').smallimap({
          dotRadius: 3,
          width: 990,
          height: 495
        }).data('api');
        smallimap.run();
        // window.smallimap = smallimap;

        // registerListener: (name, callback, sound='', subject='', category='', action='', label='')
        metricsClient.registerListener('activities', drawEventOnMap, { name: 'plop', mp3: 'sounds/plop.mp3', ogg: 'sounds/plop.ogg' }, 'siactivity');

        // Init metrics client
        metricsClient.init().run();

        // Get clients and draw them on the map
        getClientsForMap();

      });

    </script>
  </body>
</html>

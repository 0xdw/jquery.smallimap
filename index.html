<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SI Metricstest</title>
    <link rel="stylesheet" href="css/jquery.smallipop-0.1.6.min.css" type="text/css" media="all" />
  </head>
  <body>
    <h1>Smallimap Demo</h1>
    <div>
      <canvas id="smallimap" width="1000" height="500"></canvas>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
    <script src="js/jquery.smallipop-0.1.6.min.js" type="text/javascript"></script>
    <script src="js/suntimes.js"></script>
    <script src="js/renderframe.js"></script>
    <script src="js/color-0.4.1.js" type="text/javascript"></script>
    <script src="js/world.js" type="text/javascript"></script>
    <script src="js/smallimap.js" type="text/javascript"></script>
    <script src="js/some.js" type="text/javascript"></script>

    <script type="text/javascript">

      $(function() {
        var smallimap,
            debugMode = true,
            serverUrl = 'http://www.small-improvements.com';//'http://localhost:8080'

        function log(message) {
          if (window.console && $.some.debug)
            window.console.log(message);
        }

        // Callback for activity listeners
        function drawEventOnMap(listener, scheduledTimeout, event) {
          log("Scheduling activity on the map for listener " + listener.name + " in " + scheduledTimeout + " ms");

          var eventColor,
              eventDuration = 500,
              eventWeight = 1;

          switch (event.category) {
            case 'appraisal':
              eventColor = '#b4da4d'; // Yellow/Green
              break;
            case 'feedback':
              eventColor = '#35ac46'; // Light green
              break;
            case 'objective':
              eventColor = '#64a3e3'; // Blue
              break;
            case 'admin':
              eventColor = '#eaab48'; // Orange
              break;
            default:
              eventColor = '#ff00ff'; // Pink
          }

          window.setTimeout(function() {
            log("Enqueing event on the map: " + event.label);

            var newEvent = new $.si.smallimap.events.BlipEvent(smallimap, {
              latitude: event.latitude,
              longitude: event.longitude,
              color: eventColor,
              weight: eventWeight,
              length: eventDuration
            });
            smallimap.enqueueEvent(newEvent);
          }, scheduledTimeout);
        }

        // Query clients from the server and show them on the map
        function getClientsForMap() {
          $.getJSON(serverUrl + '/queryClientsJSON?callback=?', function(data) {
            log("Queried clients from SI");
            log(data);
            // TODO: implement
          });
        }

        // Test function for the map which creates random events all over the world
        var testIntervalId = -1;
        window.runSmallimapTest = function() {
          testIntervalId = setInterval(function() {
            var event = new $.si.smallimap.events.BlipEvent(smallimap, {
              latitude: Math.random() * 180 - 90,
              longitude: Math.random() * 360 - 180,
              color: '#ff00ff',
              duration: 1024
            });
            smallimap.enqueueEvent(event);
          }, 500);
        };
        window.stopSmallimapTest = function() {
          clearInterval(testIntervalId);
        };

        // Configure metrics client
        $.some.debug = debugMode;
        var metricsClient = new $.some.SonicMetricsClient('SIMetricsClient', {
          serverUrl: serverUrl,
          sourceId: 'SIMetricsClient',
          getEventsPath: 'queryActivitiesJSON',
          getServerTime: 'queryServertimeJSON',
          soundEnabled: false,
          useLocalStorage: false,
          useLastKeyOnRequests: false
        });

        // Init map
        smallimap = $('#smallimap').smallimap().data('api');
        smallimap.run();
        // window.smallimap = smallimap;

        // registerListener: (name, callback, sound='', subject='', category='', action='', label='')
        metricsClient.registerListener('activities', drawEventOnMap, '', 'siactivity');

        // Init metrics client
        metricsClient.init().run();

        // Get clients and draw them on the map
        getClientsForMap();

      });

    </script>
  </body>
</html>
